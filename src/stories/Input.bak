import { cn } from '@/lib/utils';
import React, { useState, forwardRef } from 'react';

export interface InputProps {
  type?: 'text' | 'password' | 'email' | 'textarea';
  label: string;
  placeholder?: string;
  disabled?: boolean;
  size?: 'medium' | 'large';
  backgroundColor?: string;
  helperText?: string;
  errorText?: string;
  variant?: 'primary' | 'danger' | 'outlinePink' | 'outlineGray' | 'default';
  onChange?: (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => void;
  onDeleteClick?: () => void;
}

export const Input = forwardRef<HTMLInputElement | HTMLTextAreaElement, InputProps>(
  (
    {
      type = 'text',
      label,
      placeholder = '',
      disabled = false,
      size = 'medium',
      backgroundColor,
      helperText,
      errorText,
      variant = 'default',
      onChange,
      onDeleteClick,
      ...props
    },
    ref,
  ) => {
    const [inputValue, setInputValue] = useState('');
    const [showPassword, setShowPassword] = useState(false);

    const handleDeleteClick = () => {
      setInputValue('');
      if (onChange) {
        onChange({ target: { value: '' } } as React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>);
      }
      if (onDeleteClick) {
        onDeleteClick();
      }
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
      setInputValue(e.target.value);
      if (onChange) onChange(e);
    };

    const togglePasswordVisibility = () => {
      setShowPassword(!showPassword);
    };

    const sizeClasses = {
      medium: 'py-3 px-3 text-base',
      large: 'py-4 px-4 text-lg',
    };

    const colorStyles = {
      primary: 'bg-white text-gray-900 border-primary-400 rounded-md focus:border-primary-400',
      danger: 'bg-white text-danger border-danger rounded-lg focus:text-danger focus:border-danger',
      outlinePink: 'bg-white text-secondary-400 rounded-lg border border-secondary-400 focus:border-secondary-400',
      outlineGray: 'bg-white text-gray-900 border rounded-lg border-gray-300 focus:border-gray-300',
      default: 'bg-white text-gray-900 border rounded-lg border-gray-300 focus:border-gray-300',
    };

    const labelColorStyles = {
      primary: 'text-primary-400',
      danger: 'text-danger',
      outlinePink: 'text-secondary-400',
      outlineGray: 'text-gray-900',
      default: 'text-gray-900',
    };

    const helperTextColorStyles = {
      primary: 'text-primary-300',
      danger: 'text-danger',
      outlinePink: 'text-secondary-300',
      outlineGray: 'text-gray-300',
      default: 'text-gray-300',
    };

    const disabledStyle = 'cursor-not-allowed opacity-50';
    const activeStyle = disabled
      ? disabledStyle
      : inputValue && errorText
      ? colorStyles['danger']
      : colorStyles[variant];
    const disabledLabelStyle = disabled
      ? 'text-gray-400'
      : inputValue && errorText
      ? colorStyles['danger']
      : labelColorStyles[variant];

    return (
      <fieldset>
        <label className={cn('block font-bold mb-2', disabledLabelStyle)}>{label}</label>
        <div className='relative'>
          {type === 'textarea' ? (
            <textarea
              ref={ref as React.Ref<HTMLTextAreaElement>}
              placeholder={placeholder}
              disabled={disabled}
              value={inputValue}
              onChange={handleChange}
              className={cn(
                'border rounded-md w-full pr-10 resize-none', 
                sizeClasses[size], 
                activeStyle, 
                'focus:outline-none focus:ring-2', 
                disabled ? disabledStyle : '',
              )}
              style={{ backgroundColor }}
              {...props}
            />
          ) : (
            <input
              ref={ref as React.Ref<HTMLInputElement>}
              type={type === 'password' && showPassword ? 'text' : type}
              placeholder={placeholder}
              disabled={disabled}
              value={inputValue}
              onChange={handleChange}
              className={cn(
                'border rounded-md w-full pr-10', 
                sizeClasses[size], 
                activeStyle, 
                'focus:outline-none focus:ring-2', 
                disabled ? disabledStyle : '',
              )}
              style={{ backgroundColor }}
              {...props}
            />
          )}
          {type === 'password' && (
            <button
              type='button'
              onClick={togglePasswordVisibility}
              className='absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700'
              aria-label={showPassword ? 'Hide password' : 'Show password'}
            >
              {showPassword ? (
                // Password hide icon
                <svg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg'>...</svg>
              ) : (
                // Password show icon
                <svg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg'>...</svg>
              )}
            </button>
          )}
          {inputValue && (
            <button
              type='button'
              onClick={handleDeleteClick}
              className='absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700'
              aria-label='Clear input'
            >
              <svg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg'>...</svg>
            </button>
          )}
        </div>

        {inputValue && errorText ? (
          <p className={cn('text-sm mt-1', helperTextColorStyles['danger'])}>{errorText}</p>
        ) : (
          helperText && <p className={cn('text-sm mt-1', helperTextColorStyles[variant])}>{helperText}</p>
        )}
      </fieldset>
    );
  },
);

Input.displayName = 'Input';
